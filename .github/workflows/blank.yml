# Workflow de CI para RidECI Kratos Authentication Service
# Este workflow compila el proyecto, ejecuta tests y genera reportes de cobertura

name: CI - Build, Test & Coverage

# Define cuándo se ejecuta el workflow
on:
  # Se ejecuta cuando hay un push a las ramas main o develop
  push:
    branches: 
      - main
      - develop
  
  # Se ejecuta cuando hay un pull request hacia main o develop
  pull_request:
    branches: 
      - main
      - develop
  
  # Permite ejecutar el workflow manualmente desde la pestaña Actions
  workflow_dispatch:

# Variables de entorno globales para todo el workflow
env:
  JAVA_VERSION: '17'

# Define los jobs (trabajos) que se ejecutarán
jobs:
  
  # Job principal: compilar, testear y generar cobertura
  build-and-test:
    name: Build, Test & Coverage
    runs-on: ubuntu-latest
    
    steps:
      # Paso 1: Descargar el código del repositorio
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Paso 2: Configurar Java 17
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'  # Cachea las dependencias de Maven para acelerar builds futuros
      
      # Paso 3: Cachear dependencias de Maven
      # Esto mejora el rendimiento al no descargar las dependencias en cada ejecución
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
      
      # Paso 4: Compilar el proyecto
      # -B: modo batch (no interactivo)
      # clean: limpia compilaciones anteriores
      # compile: compila el código fuente
      # --show-version: muestra la versión de Maven y Java
      - name: Build project
        run: mvn -B clean compile --show-version
      
      # Paso 5: Ejecutar tests y generar reporte de cobertura
      # test: ejecuta todos los tests
      # jacoco:report: genera el reporte de cobertura con Jacoco
      - name: Run tests with coverage
        run: mvn -B test jacoco:report
      
      # Paso 6: Subir resultados de los tests como artifact
    
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            target/surefire-reports/
            target/failsafe-reports/
          retention-days: 30
      
      # Paso 7: Subir reporte de cobertura en formato HTML
      # Solo se ejecuta si el paso anterior fue exitoso
      - name: Upload coverage report (HTML)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-html
          path: target/site/jacoco/
          retention-days: 30
      
      # Paso 8: Subir reporte de cobertura en formato XML
      # Útil para integraciones con otras herramientas
      - name: Upload coverage report (XML)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-xml
          path: target/site/jacoco/jacoco.xml
          retention-days: 30
      
      # Paso 9: Verificar umbrales de cobertura
      # Verifica que se cumplan los mínimos de cobertura definidos en pom.xml
      # continue-on-error: true significa que el workflow no falla si no se cumplen los umbrales
      - name: Check coverage thresholds
        run: mvn jacoco:check
        continue-on-error: true
      
      # Paso 10: Mostrar resumen de cobertura en la página del workflow
      # $GITHUB_STEP_SUMMARY es una variable especial que muestra información en la UI de GitHub
      # >> redirige la salida al archivo de resumen
      - name: Display coverage summary
        if: always()
        run: |
          echo "### Coverage Report Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f target/site/jacoco/index.html ]; then
            echo "Coverage report generated successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Download the coverage artifacts to view detailed report" >> $GITHUB_STEP_SUMMARY
          else
            echo "Coverage report not found" >> $GITHUB_STEP_SUMMARY
          fi

  # Job secundario: compilar sin ejecutar tests
  # Útil para verificar rápidamente que el código compila
  verify-build:
    name: Verify Build (no tests)
    runs-on: ubuntu-latest
    
    steps:
      # Paso 1: Descargar el código
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Paso 2: Configurar Java
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'
      
      # Paso 3: Compilar y empaquetar sin ejecutar tests
      # -DskipTests: salta la ejecución de tests
      # package: crea el archivo JAR
      - name: Build without tests
        run: mvn -B clean package -DskipTests
      
      # Paso 4: Subir el JAR generado como artifact
      # Útil si quieres descargar el JAR compilado
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: target/*.jar
          retention-days: 7
          
